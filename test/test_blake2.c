/*
  To the extent possible under law, Nick Mathewson has waived all copyright and
  related or neighboring rights to libottery-lite, using the creative commons
  "cc0" public domain dedication.  See doc/cc0.txt or
  <http://creativecommons.org/publicdomain/zero/1.0/> for full details.
*/

#define BLAKE2S_OUTBYTES 32
#define BLAKE2B_OUTBYTES 64
#include "blake2-kat.h"

static void
test_kat(void *arg)
{
  (void)arg;

#define ITERATIONS 256
  int i;
  /* this will fail if the platform is big-endian. Don't worry. */
  u8 buf[KAT_LENGTH];
  u8 out[64];

  for (i = 0; i < KAT_LENGTH; ++i)
    {
      buf[i] = (u8)i;
    }

  for (i = 0; i < ITERATIONS; ++i)
    {
#if BLAKE2_WORDBITS == 64
      const u8 *expected = blake2b_kat[i];
#else
      const u8 *expected = blake2s_kat[i];
#endif

      tt_int_op(BLAKE2_MAX_OUTPUT, ==,
                blake2_noendian(out, BLAKE2_MAX_OUTPUT, buf, i, 0, 0));

      tt_mem_op(out, ==, expected, BLAKE2_MAX_OUTPUT);
    }

 end:
  ;
}

static void
test_output_len(void *arg)
{
  u8 msg[] = "hi";
  u8 out[128];
  (void)arg;

  memset(out, 0, sizeof(out));

  tt_int_op(-1, ==, blake2_noendian(out, 128, msg, 3, 0, 0));
  tt_assert(iszero(out, sizeof(out)));
  tt_int_op(-1, ==, blake2_noendian(out, 0, msg, 3, 0, 0));
  tt_assert(iszero(out, sizeof(out)));
  tt_int_op(1, ==, blake2_noendian(out, 1, msg, 3, 0, 0));
  tt_assert(iszero(out+1, sizeof(out)-1));
  tt_int_op(20, ==, blake2_noendian(out, 20, msg, 3, 0, 0));
  tt_assert(iszero(out+20, sizeof(out)-20));
  tt_assert(! iszero(out, 20));
  tt_int_op(21, ==, blake2_noendian(out+20, 21, msg, 3, 0, 0));
  tt_mem_op(out, !=, out+20, 20);
 end:
  ;
}

static const struct {
  char *string;
  u8 hash[64];
  u8 personalized_hash[64];
} BLAKE2B_VECTORS[] = {
{
  "Chosen by fair dice roll. Guaranteed to be random.",
  { 0x5c, 0x20, 0xc0, 0x9a, 0x5d, 0x14, 0x8c, 0x9f, 0x73, 0x53, 0x20, 0xc3, 0x45, 0xd2, 0x00, 0xf9, 0x32, 0x24, 0xa0, 0x57, 0xce, 0x7d, 0x8e, 0xc7, 0x44, 0xa9, 0xff, 0xa8, 0x1a, 0xc7, 0x9a, 0x4f, 0x39, 0x17, 0xa7, 0xa4, 0x84, 0x2f, 0xc6, 0x7d, 0x03, 0x79, 0x86, 0xc3, 0xaa, 0x28, 0x6e, 0x67, 0x2f, 0x8c, 0x92, 0x5e, 0x90, 0x04, 0x4b, 0x9d, 0xf1, 0xbb, 0xd9, 0x16, 0x30, 0xbd, 0x2d, 0xb4,  },
  { 0xdf, 0xfd, 0x1f, 0xf9, 0x3c, 0xe5, 0xcf, 0xa9, 0x67, 0xb5, 0xb2, 0x97, 0x9d, 0x9b, 0x29, 0x7e, 0x60, 0x56, 0xc0, 0xdb, 0xbc, 0x78, 0xa8, 0x60, 0x8b, 0x79, 0x5d, 0xea, 0xd3, 0xdc, 0xe4, 0x9b, 0x65, 0x2c, 0x20, 0x0f, 0xc6, 0x2a, 0x9d, 0xc1, 0x67, 0xd9, 0x92, 0xfb, 0x03, 0x1d, 0x79, 0x3e, 0x18, 0x4e, 0x16, 0xed, 0x14, 0x69, 0x5b, 0xec, 0x4b, 0xcb, 0x5f, 0x12, 0x19, 0xaf, 0x55, 0x26,  },
},
{
  "The default PRF is ChaCha20.",
  { 0x2d, 0x61, 0xbc, 0x45, 0x87, 0x57, 0xbd, 0x1c, 0x00, 0x3d, 0xf3, 0x33, 0x15, 0xf1, 0xa6, 0x88, 0xa5, 0x9a, 0x02, 0x5a, 0xae, 0x9c, 0x74, 0xa6, 0xcb, 0x52, 0xb3, 0x80, 0x4e, 0x88, 0x24, 0x06, 0x6e, 0x0e, 0x84, 0xbd, 0xe2, 0xca, 0x58, 0xb8, 0x1a, 0x47, 0x14, 0xb3, 0x5a, 0xc5, 0xbd, 0xa1, 0x72, 0x5f, 0xcb, 0x75, 0xd0, 0x89, 0x6b, 0x9c, 0x0f, 0xff, 0x20, 0x21, 0xdb, 0x4a, 0x33, 0x7c,  },
  { 0x79, 0xd1, 0x98, 0xe7, 0x8f, 0x20, 0x51, 0x3b, 0x3e, 0xb1, 0x56, 0xa9, 0x02, 0x2a, 0xbd, 0xfd, 0x0a, 0x17, 0x45, 0x16, 0x85, 0x3f, 0x28, 0xc5, 0x4f, 0xa9, 0x4c, 0xd7, 0x8b, 0x48, 0xc9, 0x35, 0xeb, 0x05, 0x66, 0x52, 0x88, 0xa1, 0x1a, 0x1e, 0x94, 0xf6, 0x56, 0xd7, 0x57, 0x5a, 0x8a, 0xc2, 0xfa, 0xa4, 0x85, 0xab, 0x39, 0xa5, 0xc9, 0xc8, 0x31, 0x68, 0x31, 0x8f, 0x94, 0xfd, 0xeb, 0xac,  },
},
{
  "Sors immanis et inanis rota tu volubilis status malus vana salus semper dissolubilis obumbrata et velata michi quoque niteris nunc per ludum dorsum nudum fero tui sceleris Sors salutis et virtutis michi nunc contraria est affectus et defectus semper in angaria",
  { 0xf3, 0xbf, 0x04, 0xcf, 0x9d, 0x1b, 0xae, 0x8c, 0x1d, 0xce, 0x02, 0x1c, 0x7d, 0x6b, 0xe9, 0x2a, 0xe9, 0x3b, 0xdf, 0x2c, 0x69, 0x2b, 0x40, 0x4f, 0xf8, 0x7a, 0x7f, 0xa2, 0xc3, 0x31, 0xf1, 0x4b, 0x3b, 0x1b, 0x40, 0xd7, 0x0e, 0x22, 0x75, 0xb9, 0x13, 0xcf, 0x03, 0x11, 0x72, 0xd8, 0x50, 0x8f, 0x6b, 0xd0, 0x27, 0x68, 0x42, 0x45, 0xa4, 0x7e, 0x62, 0x3c, 0x50, 0xb5, 0x19, 0x00, 0xc0, 0x83,  },
  { 0xd0, 0x3a, 0x75, 0x8e, 0x25, 0x87, 0xb5, 0xc5, 0xa2, 0xed, 0x23, 0x8d, 0x6a, 0x5f, 0xf8, 0xda, 0xcf, 0xe3, 0x62, 0xf0, 0x8a, 0xdc, 0xdd, 0xf3, 0x32, 0x19, 0xcd, 0x82, 0x5c, 0xef, 0x1e, 0x17, 0x02, 0x5c, 0x40, 0x05, 0xa1, 0x8b, 0x3f, 0xaa, 0x5a, 0x69, 0x1c, 0x9a, 0x4f, 0x4e, 0xf7, 0xdf, 0xa9, 0x2e, 0x38, 0x14, 0x6f, 0x9c, 0x2c, 0xc7, 0xff, 0xc7, 0xf4, 0x6f, 0x37, 0xbd, 0xe0, 0xe7,  },
},
{
  "Zombie ipsum reversus ab viral inferno, nam malum cerebro. De c",
  { 0x31, 0xf4, 0xfa, 0x79, 0x27, 0xb1, 0x53, 0x07, 0x0d, 0xf2, 0xa2, 0xfd, 0x95, 0x25, 0xe9, 0x64, 0x96, 0x1f, 0x87, 0x8e, 0xa6, 0xc6, 0xb9, 0x28, 0xbd, 0xdb, 0x5f, 0x78, 0xd3, 0xfe, 0xcd, 0x26, 0x3f, 0xd5, 0x11, 0x04, 0xfe, 0x88, 0x26, 0xa9, 0x58, 0x4d, 0xd3, 0x46, 0x7e, 0x2a, 0xe8, 0x14, 0x96, 0xaa, 0xba, 0x4a, 0x7f, 0xc5, 0x34, 0xa1, 0x37, 0x8b, 0xdc, 0x22, 0xc2, 0x9e, 0xbd, 0x9f,  },
  { 0xdb, 0x2e, 0x75, 0xf4, 0xaf, 0xd3, 0x42, 0x84, 0xdd, 0xfe, 0x58, 0x30, 0x8b, 0xaa, 0xff, 0x69, 0x02, 0xe3, 0x44, 0xaa, 0xcd, 0x1a, 0x1f, 0x0e, 0xf5, 0x6a, 0xd9, 0xac, 0xbf, 0xe1, 0x63, 0x91, 0x24, 0x3e, 0x8e, 0xc5, 0xc0, 0x5b, 0x68, 0x13, 0x56, 0xad, 0xfa, 0xe6, 0x00, 0xe3, 0x8b, 0x21, 0x53, 0x7c, 0x31, 0x99, 0xeb, 0x3d, 0x4e, 0x91, 0x20, 0x1b, 0x4d, 0xf1, 0x8f, 0xea, 0x30, 0x3d,  },
},
{
  "arne lumbering animata corpora quaeritis.  Summus brains sit, mo",
  { 0xac, 0x20, 0xaa, 0x17, 0x77, 0xd3, 0x98, 0xe2, 0x9a, 0x1b, 0x9f, 0xe8, 0x04, 0x57, 0x96, 0xc7, 0xc6, 0x09, 0x89, 0x1b, 0x08, 0x5c, 0xf8, 0x74, 0x18, 0x68, 0x48, 0x2c, 0x5e, 0x21, 0xe2, 0xf2, 0x90, 0x3d, 0x7a, 0xd0, 0x2d, 0xcd, 0x13, 0xa8, 0x78, 0xae, 0xed, 0x78, 0xa5, 0xb8, 0x63, 0xf1, 0x0e, 0x85, 0x10, 0xeb, 0xd7, 0x11, 0x7f, 0x38, 0x83, 0xff, 0x7d, 0x66, 0x37, 0x39, 0x2d, 0x33,  },
  { 0x51, 0xab, 0xfb, 0x97, 0xb8, 0x68, 0x35, 0x6d, 0xaf, 0x32, 0xa9, 0xa0, 0xfd, 0x88, 0x8f, 0x06, 0xb6, 0x25, 0x35, 0x25, 0x4b, 0x81, 0x99, 0x4c, 0x2c, 0x06, 0x24, 0x54, 0x94, 0xf7, 0x66, 0x9c, 0xd7, 0xa7, 0xd0, 0xd4, 0x79, 0x46, 0xb7, 0x81, 0x89, 0xd4, 0x77, 0xdd, 0xad, 0x1a, 0x1b, 0xc6, 0x09, 0x3e, 0xa7, 0x70, 0xcb, 0xf1, 0x39, 0x39, 0xfe, 0xa3, 0x49, 0xf2, 0xd1, 0x22, 0x8d, 0x16,  },
},
{
  "rbo vel maleficia?  De zombie ipsum reversus ab viral inferno, na",
  { 0x2d, 0x1a, 0x3a, 0xfa, 0x01, 0x1b, 0xf9, 0xdd, 0x95, 0x75, 0x67, 0xe3, 0x3a, 0xb3, 0xbd, 0x23, 0xa6, 0xd9, 0x3b, 0x44, 0x53, 0xcc, 0xb0, 0xcf, 0x37, 0xf3, 0x08, 0xae, 0xd3, 0x22, 0x46, 0x62, 0xd3, 0xf0, 0x0f, 0x84, 0x3f, 0xb7, 0x91, 0xc6, 0x44, 0x35, 0x09, 0xfd, 0x0e, 0xb8, 0xb2, 0x95, 0x90, 0x24, 0xcf, 0xf6, 0x3a, 0x3f, 0x01, 0xec, 0x5b, 0xf4, 0x21, 0x82, 0x0e, 0xa3, 0x9d, 0x4f,  },
  { 0x39, 0xd1, 0x5a, 0xa7, 0xc6, 0xee, 0x58, 0x33, 0x12, 0x6d, 0xad, 0x02, 0x1e, 0xff, 0xb1, 0xfd, 0xf4, 0x7f, 0x74, 0xb6, 0x47, 0x65, 0x34, 0x89, 0x80, 0x8b, 0xd0, 0xd9, 0xbd, 0x25, 0x59, 0x81, 0x65, 0xef, 0x6c, 0xf5, 0x62, 0x98, 0x3f, 0x25, 0x48, 0xb6, 0x02, 0x97, 0xd7, 0x4b, 0xb9, 0x49, 0xa9, 0xc1, 0xa5, 0x0a, 0xb5, 0xf9, 0xfc, 0xe7, 0x62, 0xd8, 0xeb, 0xe5, 0xc7, 0xfd, 0xa1, 0xf0,  },
},

};

#define N_BLAKE2B_VECTORS (sizeof(BLAKE2B_VECTORS)/sizeof(BLAKE2B_VECTORS[0]))

static void
test_blake2b_vectors(void *arg)
{
  int i;
  for (i = 0; i < N_BLAKE2B_VECTORS; ++i) {
    u8 hash[64];
    u8 hashp[64];
    size_t len = strlen(BLAKE2B_VECTORS[i].string);
    TT_BLATHER(("Testing %d: %s", i, BLAKE2B_VECTORS[i].string));

    blake2_noendian(hash, 64, (void*)BLAKE2B_VECTORS[i].string, len, 0, 0);
    ottery_digest(hashp, (void*)BLAKE2B_VECTORS[i].string, len);

    tt_mem_op(hash, ==, BLAKE2B_VECTORS[i].hash, 64);
    tt_mem_op(hashp, ==, BLAKE2B_VECTORS[i].personalized_hash, 64);
  }
 end:
  ;
}

static struct testcase_t blake2_tests[] = {
  { "kat", test_kat, 0, NULL, NULL },
  { "output_len", test_output_len, 0, NULL, NULL },
  { "vectors", test_blake2b_vectors, 0, NULL, NULL },
  END_OF_TESTCASES
};

